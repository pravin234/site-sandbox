{% extends "baselayout.html" %}
{% block body %}

<title>Pies, Donuts, TV</title> 
<h1>d3 Sandbox</h1>

<h2> Pie Charts and TV Screens </h2>

<p>enter in a YouTube account or playlist to get a 
breakdown of which videos are driving views and likes</p>

<form>
	<textarea id="yt_channelid" placeholder = "thewockeez"></textarea>
</form> 

<button id= "yt_button">Hit It</button> 

<div class = "frame">
    <div class = "tooltip"></div>
</div> 

<p> <a href="http://bl.ocks.org/mbostock/1346395">mbostock reference</a>  </p> 

<ul>
	<li> YouTube Data API v3
	<li> .gitignore developer keys
	<li> jquery forms 
	<li> svg arcs and paths
  <li> ?pull in list of lists -> generate one per playlist
  <li> ?dynamic page to accomodate any # of playlists
  <li> ?for each playlist break out videos by views
  <li> ?break out videos by likes
  <li> ?hover over tooltips
  <li> ?click to see video
  <li> ?error checking for invalid channel
</ul> 

<script>

//create chart variables
var width = 900; 
var height = 400; 
var radius = Math.min(width,height)/2;
var color = d3.scale.category20();                

// defines arc
var arc = d3.svg.arc()
    .outerRadius(radius - 10)
    .innerRadius(0);

// is actually a function applied to the data
var pie = d3.layout.pie()
    .sort(null)
    .value(function(d) { return d.Workers; });

//defines svg
var svg = d3.select(".frame").append("svg")
    .attr("width", width)
    .attr("height", height)
    //what is this grouping together? 
  .append("g")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

d3.json("{{ url_for('static', filename='countries.json') }}", function(error, data) {
  var g = svg.selectAll(".arc")
  	//applies pie layout on data to calc angles
      .data(pie(data.Countries))
    .enter().append("g")
      .attr("class", "arc");

  //confused. 
  g.append("path")
      .attr("d", arc)
      .style("fill", function(d,i) { return color(i); });
});

//identify channel and url
$("#yt_button").click(function() {

  var API_key = 'AIzaSyDQH6ODAQdQ1yaxRY2xTK8krBIElQQ6KoM';

  /* 0 have a channel username */
  var yt_channel = $("#yt_channelid").val();

  /* 1 from username, get channel id*/ 
  var channel_gen_url = 'https://www.googleapis.com/youtube/v3/channels?part=snippet%2CcontentDetails%2Cstatistics&forUsername=' + yt_channel + '&key=' + API_key; 

  /*oh no, am i going to have to nest a bunch of asynchronous .getJSON calls? is that even best practice?*/
  $.getJSON(channel_gen_url)
    .done(function( channel_json ) {

      console.log(channel_json.items[0]['id']);

      var channel_id = channel_json.items[0]['id']
      var loplaylists_url = "https://www.googleapis.com/youtube/v3/playlists?part=id%2Csnippet&channelId="+ channel_id + "&maxResults=50&key=" + API_key

      /* 2 - list of playlists */ 
      $.getJSON(loplaylists_url)
        .done(function( loplaylists_json ){

          /*it works but feels so wrong*/ 
          var loplaylists_array = [];
          for (var i=0; i< loplaylists_json['items'].length; i++) {
            loplaylists_array.push(loplaylists_json['items'][i]['id'])
          }
          console.log(loplaylists_array);

          /*3 - videos in playlists*/ 
          var playlist_urls_array = [];
          for (var i=0; i< loplaylists_array.length; i++) {
            playlist_urls_array.push("https://www.googleapis.com/youtube/v3/playlistItems?part=id%2Csnippet%2CcontentDetails%2Cstatus&playlistId=" + loplaylists_array[i] + "&key=" + API_key);
          }
          console.log(playlist_urls_array); 
          
          for (var i=0; i< playlist_urls_array.length; i++) {
            $.getJSON(playlist_urls_array[i])
              .done(function( playlist_json ){
                /*forgot about paging after first 5 items*/ 
                console.log(playlist_json['items'])
                traceme();
              })
          }
          /*num asynch calls 1 + 1 + num_playlists */
          /*num youtube api calls: 1 + 1 + num_playlists*/ 
        }); 
    });

  var testing = [];

  function traceme(jsonstuff) {
    testing.push(jsonstuff);
  };

  /*this doesn't work because it actually gets called BEFORE the getjson calls */ 
  console.log("outside of traceme scope");
  console.log(testing);
  
  /*BIG DILEMMA: how to have a function that waits until all the asynch calls are in and the data's loaded before kicking off */ 

}); 

</script>

{% endblock %}